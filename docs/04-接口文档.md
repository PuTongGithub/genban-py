# 对外接口文档

## 基础信息

- **Base URL**: `http://localhost:8000`
- **接口前缀**: `/api`

---

## 1. 获取模型列表

### 接口描述
获取所有可用的 AI 模型名称

### 请求信息

**方法**: `GET`  
**路径**: `/api/get_models`

### 请求示例

```bash
curl -X GET "http://localhost:8000/api/get_models"
```

### 响应示例

```json
["qwen3-14b", "qwen3-32b", "qwen3-max", "qwen-plus", "qwen-turbo"]
```

### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| - | `string[]` | 模型名称数组 |

---

## 2. 创建新会话

### 接口描述
创建一个新的对话会话，返回会话 ID

### 请求信息

**方法**: `GET`  
**路径**: `/api/new_session`

### 请求示例

```bash
curl -X GET "http://localhost:8000/api/new_session"
```

### 响应示例

```json
"1739101234"
```

### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| - | `string` | 会话 ID |

---

## 3. 流式对话

### 接口描述
发送消息并流式接收 AI 响应（Server-Sent Events）。支持多轮大模型调用和工具调用，可能返回 `assistant` 和 `tool` 两种角色的消息。

### 请求信息

**方法**: `POST`  
**路径**: `/api/talk`  
**Content-Type**: `application/json`

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| session_id | `string` | 是 | 会话 ID（通过 `/api/new_session` 获取） |
| user_input | `string` | 是 | 用户输入内容 |
| model | `string` | 是 | 模型名称（从 `/api/get_models` 获取） |

### 请求示例

```bash
curl -X POST "http://localhost:8000/api/talk" \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "1739101234.567",
    "user_input": "你好，请介绍一下自己",
    "model": "qwen3-32b"
  }'
```

### 响应格式

**Content-Type**: `text/event-stream`

响应采用 SSE (Server-Sent Events) 格式，包含以下三种事件类型：

#### 1. message 事件

流式返回 AI 的回答内容，每次返回全量内容。根据消息角色不同，返回的字段有所区别。

**事件格式 - assistant 角色**:
```
event: message
data: {"role": "assistant", "content": "回答内容", "reasoning_content": "思考过程"}
```

**事件格式 - tool 角色**:
```
event: message
data: {"role": "tool", "content": "工具调用结果"}
```

**响应字段说明**:

| 字段                | 类型       | 说明                      | 适用角色 |
| ----------------- | -------- | ----------------------- | -------- |
| role              | `string` | 消息角色，可能为 `"assistant"` 或 `"tool"` | 所有 |
| content           | `string` | AI 的回答内容或工具调用结果（全量，每次返回完整内容） | 所有 |
| reasoning_content | `string` | AI 的思考过程内容（全量，每次返回完整内容） | 仅 `assistant` |

#### 2. complete 事件

当 AI 回答完成时触发，表示流式响应结束。

**事件格式**:
```
event: complete
data: 
```

#### 3. error 事件

当接口发生错误时触发。

**事件格式**:
```
event: error
data: {"error": "错误描述信息"}
```

### 响应示例

#### 示例 1：普通对话（无工具调用）

```
event: message
data: {"role": "assistant", "content": "", "reasoning_content": "让我"}

event: message
data: {"role": "assistant", "content": "", "reasoning_content": "让我思考"}

event: message
data: {"role": "assistant", "content": "", "reasoning_content": "让我思考一下..."}

event: message
data: {"role": "assistant", "content": "你好", "reasoning_content": "让我思考一下..."}

event: message
data: {"role": "assistant", "content": "你好！", "reasoning_content": "让我思考一下..."}

event: complete
data: 
```

#### 示例 2：工具调用场景

```
event: message
data: {"role": "assistant", "content": "", "reasoning_content": "用户想查询天气"}

event: message
data: {"role": "assistant", "content": "", "reasoning_content": "用户想查询天气，我需要调用天气工具"}

event: message
data: {"role": "assistant", "content": "我来为您查询天气", "reasoning_content": "用户想查询天气，我需要调用天气工具"}

event: message
data: {"role": "tool", "content": "北京今天晴，25°C"}

event: message
data: {"role": "assistant", "content": "", "reasoning_content": "工具返回了天气信息"}

event: message
data: {"role": "assistant", "content": "北京今天天气晴朗，气温25°C", "reasoning_content": "工具返回了天气信息"}

event: complete
data: 
```

### 注意事项

1. **全量返回**: 每次 `message` 事件返回的 `content` 和 `reasoning_content` 都是**全量内容**，前端直接替换显示即可，无需拼接
2. **多角色消息**: 接口可能返回 `role="assistant"` 和 `role="tool"` 两种角色的消息，前端需要根据角色进行不同的展示处理
3. **工具调用流程**: 当 `assistant` 消息触发工具调用时，会依次返回工具调用结果（`role="tool"`），流式输出中的每个tool消息都包含完整的调用结果，前端展示时需要逐个展示。然后继续返回 `assistant` 的最终回复
4. **多轮调用**: 单次 `/talk` 调用可能涉及多轮大模型调用（工具调用场景），前端需要持续监听直到收到 `complete` 事件
5. **sessionId**: 前端需要维护会话 ID，用于多轮对话上下文
6. **模型选择**: 先调用 `/get_models` 获取可用模型列表
7. **错误处理**: 需要监听 `error` 事件处理异常情况
8. **完成标识**: 通过 `complete` 事件判断流式响应结束
